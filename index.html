<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Schedule Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .form-section {
            border: 1px solid #e2e8f0; /* slate-200 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #ffffff;
        }
        .form-section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b; /* slate-800 */
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }
        /* Styles for the confirmation modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 500px;
            width: 90%;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 md:p-6">

    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl w-full border border-slate-200">
        <div class="relative text-center mb-8">
            <div class="absolute left-0 top-0 flex items-center gap-3 h-full">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSIjRkRCMDEzIi8+PHRleHQgeD0iNTAiIHk9IjY1IiBmb250LWZhbWlseT0iY3Vyc2l2ZSwgc2VyaWYiIGZvbnQtc2l6ZT0iNjAiIGZvbnQtd2VpZ2h0PSJib2xkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSI+RzwvdGV4dD48L3N2Zz4=" alt="GBI Logo" class="h-10 w-10 object-contain">
                <span class="text-2xl font-bold text-slate-700">GBI</span>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 inline-block">Employee Schedule Manager</h2>
        </div>
        
        <!-- Login Section -->
        <div id="login-section" class=" p-8 border-2 border-dashed rounded-lg">
            <h3 class="text-xl font-semibold text-slate-700 mb-4">Sign In or Create Account</h3>
             <div id="auth-status" class="text-center mb-4 p-2 rounded-lg text-sm font-medium hidden"></div>
            <div class="space-y-4">
                 <div>
                     <label for="email" class="block text-sm font-medium text-slate-700 text-left">Email</label>
                     <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                 </div>
                 <div>
                     <label for="password" class="block text-sm font-medium text-slate-700 text-left">Password (min. 6 characters)</label>
                     <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                 </div>
                 <div class="flex gap-4">
                     <button id="signin-btn" class="w-full flex justify-center items-center gap-2 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700">Sign In</button>
                     <button id="create-account-btn" class="w-full flex justify-center items-center gap-2 py-2 px-4 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50">Create Account</button>
                 </div>
                  <div class="relative my-4">
                   <div class="absolute inset-0 flex items-center" aria-hidden="true">
                     <div class="w-full border-t border-gray-300"></div>
                   </div>
                   <div class="relative flex justify-center">
                     <span class="bg-white px-2 text-sm text-gray-500">Or continue with</span>
                   </div>
                 </div>
                 <button id="google-signin-btn" class="w-full inline-flex items-center justify-center gap-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-semibold py-2 px-6 rounded-lg transition-colors">
                     <svg class="w-5 h-5" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 23.4 172.9 62.3l-66.5 64.6C305.5 114.6 279.8 100 248 100c-73 0-132.3 59.2-132.3 132S175 364 248 364c42.4 0 79.4-20.4 104.2-51.6H248v-85.3h236.1c2.3 12.7 3.9 26.9 3.9 41.4z"></path></svg>
                     Sign in with Google
                 </button>
            </div>
        </div>

        <!-- Main App Content (Initially Hidden) -->
        <div id="app-content" class="hidden">
             <div id="connection-status" class="flex justify-between items-center text-center mb-4 p-2 rounded-lg text-sm font-medium bg-slate-100 text-slate-700">
                <span id="user-display"></span>
                <button id="sign-out-btn" class="flex-shrink-0 flex items-center gap-2 py-1 px-3 border border-slate-300 rounded-lg shadow-sm text-xs font-medium text-slate-700 bg-white hover:bg-slate-50">
                    <span>Sign Out</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </button>
            </div>
            <!-- CSV Upload Section -->
            <div class="form-section bg-slate-50/50">
                <h3 class="form-section-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <span>Bulk Upload (CSV)</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                    <div class="md:col-span-2">
                        <label for="csv-file-input" class="sr-only">Select CSV File</label>
                        <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 transition-colors">
                    </div>
                    <div class="self-end">
                        <button type="button" id="upload-csv-btn" class="w-full flex justify-center items-center gap-2 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700">
                            Preview CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Form for entering schedule data -->
            <form id="schedule-form" class="space-y-6">
                <!-- Employee Information Section -->
                <div class="form-section">
                    <h3 class="form-section-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>Manual Entry</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="owfId" class="block text-sm font-medium text-slate-700">OWF ID</label>
                            <input type="text" id="owfId" name="owfId" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., 12345" required>
                        </div>
                        <div>
                            <label for="employeeName" class="block text-sm font-medium text-slate-700">Employee Name</label>
                            <input type="text" id="employeeName" name="employeeName" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., Bloy, Carlito" required>
                        </div>
                        <div>
                            <label for="agencyName" class="block text-sm font-medium text-slate-700">Agency Name</label>
                            <select id="agencyName" name="agencyName" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                                <option value="">Select an Agency</option>
                                <option value="STAFF ALLIANCE">STAFF ALLIANCE</option>
                                <option value="BMIRK">BMIRK</option>
                                <option value="EXPEDISE">EXPEDISE</option>
                                <option value="GREEN PASTURE">GREEN PASTURE</option>
                                <option value="UNKNOWN">UNKNOWN</option>
                            </select>
                        </div>
                        <div>
                            <label for="zone" class="block text-sm font-medium text-slate-700">Zone</label>
                            <input type="text" id="zone" name="zone" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., FEMS" required>
                        </div>
                        <div>
                            <label for="site" class="block text-sm font-medium text-slate-700">Site</label>
                            <select id="site" name="site" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                                <option value="">Select a Site</option>
                                <option value="CP">CP</option>
                                <option value="BP">BP</option>
                                <option value="CFC">CFC</option>
                                <option value="Unknown">Unknown</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Schedule Blocks Section -->
                <div id="schedule-blocks-container" class="form-section">
                    <div class="schedule-block border-none p-0 m-0">
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-slate-700">Schedule 1</h3>
                            <button type="button" class="remove-schedule-btn hidden text-sm font-medium text-red-600 hover:text-red-800">&times; Remove</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="transactionDateFrom_1" class="block text-sm font-medium text-slate-700">Date From</label>
                                <input type="date" name="transactionDateFrom" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                            </div>
                            <div>
                                <label for="transactionDateTo_1" class="block text-sm font-medium text-slate-700">Date To</label>
                                <input type="date" name="transactionDateTo" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required>
                            </div>
                            <div class="md:col-span-2">
                                <label for="workSchedule_1" class="block text-sm font-medium text-slate-700">Work Schedule</label>
                                <input type="text" name="workSchedule" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., 8am-5pm" required>
                            </div>
                            <div class="md:col-span-2">
                                <label for="restDay_1" class="block text-sm font-medium text-slate-700">Rest Day</label>
                                <select name="restDay" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                                    <option value="">Select a Day</option>
                                    <option value="Sunday">Sunday</option>
                                    <option value="Monday">Monday</option>
                                    <option value="Tuesday">Tuesday</option>
                                    <option value="Wednesday">Wednesday</option>
                                    <option value="Thursday">Thursday</option>
                                    <option value="Friday">Friday</option>
                                    <option value="Saturday">Saturday</option>
                                    <option value="Unknown">Unknown</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="button" id="add-schedule-btn" class="w-full flex justify-center items-center gap-2 py-2 px-4 border-2 border-dashed border-slate-300 rounded-lg text-sm font-medium text-slate-600 hover:border-sky-500 hover:text-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Another Schedule Block
                </button>
                
                <!-- Specific Schedule Changes Section -->
                <div class="form-section">
                     <h3 class="form-section-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><path d="M8 2v4"></path><path d="M16 2v4"></path><rect width="18" height="18" x="3" y="4" rx="2"></rect><path d="M3 10h18"></path><path d="m9 16 2 2 4-4"></path></svg>
                        <span>Special Schedule Changes (Optional)</span>
                    </h3>
                    <div id="specific-changes-container" class="space-y-4">
                        <!-- Template for a single change -->
                        <div id="specific-change-template" class="specific-change-block grid grid-cols-1 md:grid-cols-3 gap-4 items-center hidden">
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Day of Week</label>
                                <select name="specificDay" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                                    <option value="">Select a Day</option>
                                    <option value="Monday">Monday</option>
                                    <option value="Tuesday">Tuesday</option>
                                    <option value="Wednesday">Wednesday</option>
                                    <option value="Thursday">Thursday</option>
                                    <option value="Friday">Friday</option>
                                    <option value="Saturday">Saturday</option>
                                    <option value="Sunday">Sunday</option>
                                    <option value="Unknown">Unknown</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">New Work Schedule</label>
                                <input type="text" name="specificSchedule" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., 7am-4pm or RESTDAY">
                            </div>
                            <div class="self-end pt-5">
                                 <button type="button" class="remove-specific-btn w-full flex items-center justify-center gap-2 py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-red-600 hover:text-red-800 hover:bg-red-50 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="add-specific-change-btn" class="mt-4 w-full flex justify-center items-center gap-2 py-2 px-4 border-2 border-dashed border-slate-300 rounded-lg text-sm font-medium text-slate-600 hover:border-sky-500 hover:text-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add Specific Change
                    </button>
                </div>
                
                <!-- Vacation Leave Section -->
                <div class="form-section">
                     <h3 class="form-section-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line><path d="m9 16 2 2 4-4"></path></svg>
                        <span>Vacation Leave (Optional)</span>
                    </h3>
                    <div id="vacation-leave-container" class="space-y-4">
                        <!-- Template for a single leave date -->
                        <div id="vacation-leave-template" class="vacation-leave-block grid grid-cols-1 md:grid-cols-3 gap-4 items-center hidden">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-slate-700">Leave Date</label>
                                <input type="date" name="vacationDate" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                            </div>
                            <div class="self-end pt-5">
                                 <button type="button" class="remove-leave-btn w-full flex items-center justify-center gap-2 py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-red-600 hover:text-red-800 hover:bg-red-50 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="add-vacation-leave-btn" class="mt-4 w-full flex justify-center items-center gap-2 py-2 px-4 border-2 border-dashed border-slate-300 rounded-lg text-sm font-medium text-slate-600 hover:border-sky-500 hover:text-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add Vacation Leave
                    </button>
                </div>

                <div class="pt-4">
                    <button type="submit" id="submit-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-sky-600 hover:bg-sky-700">
                        Save Schedules to Database
                    </button>
                </div>
            </form>

            <!-- Status message for feedback -->
            <div id="status-message" class="mt-6 text-center hidden p-3 rounded-lg"></div>

            <!-- Container for the output table and buttons -->
            <div id="output-container" class="mt-8 border-t-2 border-slate-200 pt-8">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h3 id="table-title" class="text-xl font-bold text-slate-800">Schedules from Database</h3>
                    <div class="flex space-x-2">
                        <button id="delete-selected-btn" class="hidden flex items-center gap-2 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            Delete Selected
                        </button>
                        <button id="save-csv-data-btn" class="hidden flex items-center gap-2 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all">
                            Save CSV Data to Database
                        </button>
                        <button id="export-button" class="flex items-center gap-2 py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-all">
                            Export View
                        </button>
                        <button id="clear-button" class="flex items-center gap-2 py-2 px-4 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all">
                            Clear View
                        </button>
                    </div>
                </div>
                 <!-- Filter Controls -->
                <div class="mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="filter-owfid" class="block text-sm font-medium text-slate-700">OWF ID</label>
                            <input type="text" id="filter-owfid" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        </div>
                        <div>
                            <label for="filter-name" class="block text-sm font-medium text-slate-700">Employee Name</label>
                            <input type="text" id="filter-name" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        </div>
                         <div>
                            <label for="filter-agency" class="block text-sm font-medium text-slate-700">Agency</label>
                            <input type="text" id="filter-agency" list="agency-list" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                            <datalist id="agency-list"></datalist>
                        </div>
                         <div>
                            <label for="filter-date" class="block text-sm font-medium text-slate-700">Date</label>
                            <input type="date" id="filter-date" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        </div>
                         <div>
                            <label for="filter-schedule" class="block text-sm font-medium text-slate-700">Schedule</label>
                            <input type="text" id="filter-schedule" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        </div>
                         <div>
                            <label for="filter-zone" class="block text-sm font-medium text-slate-700">Zone</label>
                            <input type="text" id="filter-zone" list="zone-list" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                             <datalist id="zone-list"></datalist>
                        </div>
                         <div>
                            <label for="filter-site" class="block text-sm font-medium text-slate-700">Site</label>
                           <input type="text" id="filter-site" list="site-list" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                           <datalist id="site-list"></datalist>
                        </div>
                        <div class="self-end">
                            <button id="clear-filter-btn" class="w-full flex justify-center items-center gap-2 py-2 px-4 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50">
                                Clear All Filters
                            </button>
                        </div>
                    </div>
                </div>
                <div id="top-scrollbar-container" class="overflow-x-auto">
                    <div id="top-scrollbar-dummy" style="height: 1px;"></div>
                </div>
                <div id="bottom-scrollbar-container" class="overflow-x-auto rounded-lg border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider"><input type="checkbox" id="select-all-checkbox"></th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">OWF ID</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Agency</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Schedule</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Total Hours</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Zone</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Site</th>
                            </tr>
                        </thead>
                        <tbody id="output-table-body" class="bg-white divide-y divide-slate-200">
                            <tr><td colspan="9" class="text-center p-8 text-slate-500">Please sign in to view schedules.</td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <div id="pagination-controls" class="mt-4 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <label for="items-per-page" class="text-sm text-slate-600">Rows per page:</label>
                        <select id="items-per-page" class="border-slate-300 rounded-lg text-sm">
                            <option value="100">100</option>
                            <option value="250">250</option>
                            <option value="500">500</option>
                        </select>
                    </div>
                    <span id="page-info" class="text-sm text-slate-600"></span>
                    <div class="flex gap-2">
                        <button id="prev-page-btn" class="px-3 py-1 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                        <button id="next-page-btn" class="px-3 py-1 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-between items-center text-xs text-gray-400 mt-6">
            <div>© 2025 Powered by: EZONE</div>
            <div>Version: Angel Cake (DB)</div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-lg font-bold text-slate-800 mb-4">Confirm Deletion</h3>
            <p id="modal-message" class="text-slate-600 mb-6">Are you sure you want to delete these records? This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="py-2 px-4 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 bg-white hover:bg-slate-50">Cancel</button>
                <button id="modal-confirm-btn" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, query, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE SETUP ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-schedule-app';
        
        // --- GLOBAL APP STATE ---
        let db, auth, currentUserId, schedulesUnsubscribe;
        let csvDataToSave = [];
        let schedulesFromDB = [];
        let currentPage = 1;
        let itemsPerPage = 100;
        let selectedToDelete = new Set();
        let deleteResolver = null;

        // --- DOM ELEMENTS ---
        let loginSection, appContent, uploadCsvBtn, submitBtn, saveCsvDataBtn, tableTitle, prevPageBtn, nextPageBtn, pageInfo, itemsPerPageSelect, deleteSelectedBtn, selectAllCheckbox, filterOwfId, filterName, filterAgency, filterDate, filterSchedule, filterZone, filterSite, clearFilterBtn, topScrollbarContainer, topScrollbarDummy, bottomScrollbarContainer, authStatus, confirmationModal, modalTitle, modalMessage, modalConfirmBtn, modalCancelBtn, emailInput, passwordInput, signinBtn, createAccountBtn, googleSigninBtn, signOutBtn, connectionStatus, userDisplay;
        let isScrolling = false;

        function initializeDOMElements() {
            loginSection = document.getElementById('login-section');
            appContent = document.getElementById('app-content');
            uploadCsvBtn = document.getElementById('upload-csv-btn');
            submitBtn = document.getElementById('submit-btn');
            saveCsvDataBtn = document.getElementById('save-csv-data-btn');
            tableTitle = document.getElementById('table-title');
            prevPageBtn = document.getElementById('prev-page-btn');
            nextPageBtn = document.getElementById('next-page-btn');
            pageInfo = document.getElementById('page-info');
            itemsPerPageSelect = document.getElementById('items-per-page');
            deleteSelectedBtn = document.getElementById('delete-selected-btn');
            selectAllCheckbox = document.getElementById('select-all-checkbox');
            filterOwfId = document.getElementById('filter-owfid');
            filterName = document.getElementById('filter-name');
            filterAgency = document.getElementById('filter-agency');
            filterDate = document.getElementById('filter-date');
            filterSchedule = document.getElementById('filter-schedule');
            filterZone = document.getElementById('filter-zone');
            filterSite = document.getElementById('filter-site');
            clearFilterBtn = document.getElementById('clear-filter-btn');
            topScrollbarContainer = document.getElementById('top-scrollbar-container');
            topScrollbarDummy = document.getElementById('top-scrollbar-dummy');
            bottomScrollbarContainer = document.getElementById('bottom-scrollbar-container');
            authStatus = document.getElementById('auth-status');
            confirmationModal = document.getElementById('confirmation-modal');
            modalTitle = document.getElementById('modal-title');
            modalMessage = document.getElementById('modal-message');
            modalConfirmBtn = document.getElementById('modal-confirm-btn');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            emailInput = document.getElementById('email');
            passwordInput = document.getElementById('password');
            signinBtn = document.getElementById('signin-btn');
            createAccountBtn = document.getElementById('create-account-btn');
            googleSigninBtn = document.getElementById('google-signin-btn');
            signOutBtn = document.getElementById('sign-out-btn');
            connectionStatus = document.getElementById('connection-status');
            userDisplay = document.getElementById('user-display');
        }

        // --- MAIN INITIALIZATION & AUTH LOGIC ---
        async function main() {
            console.log("Initializing Firebase...");
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug');

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    handleSuccessfulAuth(user);
                } else {
                    handleSignedOutState();
                }
            });
        }

        function handleSuccessfulAuth(user) {
            console.log("Authentication successful. UID:", user.uid);
            currentUserId = user.uid;
            
            loginSection.classList.add('hidden');
            appContent.classList.remove('hidden');
            userDisplay.textContent = `Signed in as ${user.email || 'Anonymous'}`;
            
            listenForSchedules();
        }

        function handleSignedOutState() {
            console.log("User is signed out.");
            if (schedulesUnsubscribe) schedulesUnsubscribe();
            currentUserId = null;
            schedulesFromDB = [];
            csvDataToSave = [];
            selectedToDelete.clear();
            
            appContent.classList.add('hidden');
            loginSection.classList.remove('hidden');
            document.getElementById('output-table-body').innerHTML = '<tr><td colspan="9" class="text-center p-8 text-slate-500">Please sign in to view schedules.</td></tr>';
            tableTitle.textContent = "Schedules from Database";
            saveCsvDataBtn.classList.add('hidden');
            deleteSelectedBtn.classList.add('hidden');
        }

        // --- FIRESTORE REAL-TIME LISTENER ---
        function listenForSchedules() {
            if (!currentUserId) return;
            if (schedulesUnsubscribe) schedulesUnsubscribe();
            
            const schedulesCollectionPath = `/artifacts/${appId}/users/${currentUserId}/schedules`;
            const q = query(collection(db, schedulesCollectionPath));

            schedulesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                schedulesFromDB = [];
                querySnapshot.forEach((doc) => {
                    schedulesFromDB.push(doc.data());
                });
                schedulesFromDB.sort((a, b) => {
                    if (a.owfId < b.owfId) return -1;
                    if (a.owfId > b.owfId) return 1;
                    return new Date(a.date) - new Date(b.date);
                });
                
                populateFilterSuggestions(schedulesFromDB);

                if (csvDataToSave.length === 0) {
                    applyAndRenderFilters();
                }
            }, (error) => {
                console.error("Error listening to schedules:", error);
                showStatusMessage("Error fetching real-time data from the database.", "error");
            });
        }

        // --- FILTERING & RENDERING LOGIC ---
        function populateFilterSuggestions(schedules) {
            const agencies = [...new Set(schedules.map(s => s.agencyName))];
            const zones = [...new Set(schedules.map(s => s.zone))];
            const sites = [...new Set(schedules.map(s => s.site))];

            populateDatalist(document.getElementById('agency-list'), agencies);
            populateDatalist(document.getElementById('zone-list'), zones);
            populateDatalist(document.getElementById('site-list'), sites);
        }

        function populateDatalist(datalistElement, options) {
            datalistElement.innerHTML = ''; // Reset
            options.sort().forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                datalistElement.appendChild(opt);
            });
        }

        function applyAndRenderFilters() {
            const filters = {
                owfId: filterOwfId.value.trim().toLowerCase(),
                employeeName: filterName.value.trim().toLowerCase(),
                agencyName: filterAgency.value.trim().toLowerCase(),
                date: filterDate.value,
                schedule: filterSchedule.value.trim().toLowerCase(),
                zone: filterZone.value.trim().toLowerCase(),
                site: filterSite.value.trim().toLowerCase()
            };
            
            const sourceData = csvDataToSave.length > 0 ? csvDataToSave : schedulesFromDB;

            const filteredSchedules = sourceData.filter(schedule => {
                return Object.entries(filters).every(([key, value]) => {
                    if (!value) return true;
                    if (schedule[key] === undefined || schedule[key] === null) return false;
                    if (key === 'date') return schedule.date === value;
                    return String(schedule[key]).toLowerCase().includes(value);
                });
            });

            currentPage = 1;
            renderSchedulesToTable(filteredSchedules);
        }

        function renderSchedulesToTable(schedules) {
            const outputTableBody = document.getElementById('output-table-body');
            outputTableBody.innerHTML = ''; 

            const totalItems = schedules.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = schedules.slice(startIndex, endIndex);

            if (paginatedItems.length === 0) {
                outputTableBody.innerHTML = `<tr><td colspan="9" class="text-center p-8 text-slate-500">No schedules match the current filter.</td></tr>`;
            } else {
                 paginatedItems.forEach(schedule => {
                    const docId = `${schedule.owfId}_${schedule.date}`;
                    const newRow = outputTableBody.insertRow();
                    const isChecked = selectedToDelete.has(docId);
                    newRow.innerHTML = `
                        <td class="px-6 py-4"><input type="checkbox" class="delete-checkbox" data-doc-id="${docId}" ${isChecked ? 'checked' : ''}></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${schedule.owfId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${schedule.employeeName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${schedule.agencyName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${schedule.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${schedule.schedule}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-slate-500">${(schedule.totalHours || 0).toFixed(1)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${schedule.zone}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${schedule.site}</td>
                    `;
                });
            }
            updatePaginationControls(totalPages);
            updateScrollbarWidth();
        }

        function updatePaginationControls(totalPages) {
            pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            selectAllCheckbox.checked = false;
        }

        function updateScrollbarWidth() {
            const table = bottomScrollbarContainer.querySelector('table');
            if (table && topScrollbarDummy) {
                topScrollbarDummy.style.width = table.scrollWidth + 'px';
            }
        }

        // --- DOM MANIPULATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeDOMElements();
            main(); 

            // --- Auth Event Listeners ---
            googleSigninBtn.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                showAuthStatus('Opening Google sign-in...', 'info');
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Google Sign-In Failed:", error);
                    showAuthStatus(`Sign-in failed: ${error.message}`, "error");
                }
            });

            signinBtn.addEventListener('click', async () => {
                showAuthStatus('Signing in...', 'info');
                try {
                    await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                } catch (error) {
                    showAuthStatus(error.message, 'error');
                }
            });

            createAccountBtn.addEventListener('click', async () => {
                showAuthStatus('Creating account...', 'info');
                try {
                    await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                    showAuthStatus('Account created successfully! Please sign in.', 'success');
                } catch (error) {
                    showAuthStatus(error.message, 'error');
                }
            });
            
            signOutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    console.log('User signed out successfully.');
                } catch (error) {
                    console.error('Sign out error:', error);
                    showStatusMessage('Error signing out.', 'error');
                }
            });


            const scheduleForm = document.getElementById('schedule-form');
            const clearButton = document.getElementById('clear-button');
            const exportButton = document.getElementById('export-button');
            const addScheduleBtn = document.getElementById('add-schedule-btn');
            const scheduleBlocksContainer = document.getElementById('schedule-blocks-container');
            const csvFileInput = document.getElementById('csv-file-input');
            const addSpecificChangeBtn = document.getElementById('add-specific-change-btn');
            const specificChangesContainer = document.getElementById('specific-changes-container');
            const specificChangeTemplate = document.getElementById('specific-change-template');
            const addVacationLeaveBtn = document.getElementById('add-vacation-leave-btn');
            const vacationLeaveContainer = document.getElementById('vacation-leave-container');
            const vacationLeaveTemplate = document.getElementById('vacation-leave-template');
            let scheduleBlockCount = 1;

            uploadCsvBtn.addEventListener('click', () => {
                if (!currentUserId) {
                    showStatusMessage("You must be signed in to upload.", "error");
                    return;
                }
                const file = csvFileInput.files[0];
                if (!file) {
                    showStatusMessage('Please select a CSV file first.', 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => processCSVForPreview(event.target.result);
                reader.readAsText(file);
            });

            function processCSVForPreview(csvText) {
                const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
                if (lines.length <= 1) {
                    showStatusMessage('No data found in the CSV file.', 'error', true);
                    return;
                }
                csvDataToSave = [];
                const dataRows = lines.slice(1);
                dataRows.forEach(line => {
                    const columns = parseCsvLine(line);
                    if (columns.length < 10) return;
                    const recordType = columns[0].toLowerCase();
                    const employeeInfo = { owfId: columns[1], employeeName: columns[2], agencyName: columns[3], zone: columns[4], site: columns[5] };
                    if (recordType === 'main') {
                        const scheduleData = { transactionDateFrom: columns[6], transactionDateTo: columns[7], workSchedule: columns[8], restDay: columns[9] };
                        const schedules = generateSchedules(employeeInfo, scheduleData, {});
                        csvDataToSave.push(...schedules);
                    } else if (recordType === 'override') {
                         const overrideDate = columns[6];
                         const overrideSchedule = columns[8];
                         if (!employeeInfo.owfId || !overrideDate) return;
                         const scheduleToDisplay = convertToMilitaryTime(overrideSchedule);
                         const totalHours = calculateWorkHours(scheduleToDisplay);
                         const scheduleEntry = { ...employeeInfo, date: overrideDate, schedule: scheduleToDisplay, totalHours };
                         csvDataToSave.push(scheduleEntry);
                    }
                });
                applyAndRenderFilters();
                tableTitle.textContent = `CSV Preview (${csvDataToSave.length} rows)`;
                saveCsvDataBtn.classList.remove('hidden');
                showStatusMessage('CSV data is now in preview. Click "Save CSV Data" to commit to the database.', 'info', true);
            }

            saveCsvDataBtn.addEventListener('click', async () => {
                if(csvDataToSave.length === 0) {
                    showStatusMessage('No CSV data to save.', 'error', true);
                    return;
                }
                showStatusMessage(`Saving ${csvDataToSave.length} entries from CSV...`, 'info', true);
                const allSchedulePromises = csvDataToSave.map(schedule => saveScheduleToDB(schedule));
                try {
                    await Promise.all(allSchedulePromises);
                    showStatusMessage(`Successfully saved ${csvDataToSave.length} schedule entries from CSV.`, 'success', true);
                    csvDataToSave = [];
                    saveCsvDataBtn.classList.add('hidden');
                    tableTitle.textContent = "Schedules from Database";
                } catch (error) {
                    console.error("Error saving CSV data to Firestore:", error);
                    showStatusMessage("An error occurred while saving CSV data.", "error", true);
                }
            });
            
            scheduleForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                if (!currentUserId) {
                    showStatusMessage("You must be signed in to save.", "error");
                    return;
                }
                const employeeInfo = {
                    owfId: document.getElementById('owfId').value,
                    employeeName: document.getElementById('employeeName').value,
                    agencyName: document.getElementById('agencyName').value,
                    zone: document.getElementById('zone').value,
                    site: document.getElementById('site').value
                };
                if (!employeeInfo.owfId || !employeeInfo.employeeName || !employeeInfo.agencyName || !employeeInfo.zone || !employeeInfo.site) {
                    showStatusMessage('Please fill out all employee information fields.', 'error');
                    return;
                }
                const overrides = {};
                document.querySelectorAll('.vacation-leave-block:not(#vacation-leave-template)').forEach(block => {
                    const date = block.querySelector('[name="vacationDate"]').value;
                    if (date) overrides[`${employeeInfo.owfId}-${date}`] = 'VACATION LEAVE';
                });
                document.querySelectorAll('.specific-change-block:not(#specific-change-template)').forEach(block => {
                    const day = block.querySelector('[name="specificDay"]').value;
                    const schedule = block.querySelector('[name="specificSchedule"]').value;
                    if (day && schedule) overrides[day.toLowerCase()] = schedule;
                });
                let allSchedulesValid = true;
                const scheduleBlocks = scheduleBlocksContainer.querySelectorAll('.schedule-block');
                const allSchedulePromises = [];
                scheduleBlocks.forEach(block => {
                    const scheduleData = {
                        transactionDateFrom: block.querySelector('[name="transactionDateFrom"]').value,
                        transactionDateTo: block.querySelector('[name="transactionDateTo"]').value,
                        workSchedule: block.querySelector('[name="workSchedule"]').value,
                        restDay: block.querySelector('[name="restDay"]').value,
                    };
                    if (!scheduleData.transactionDateFrom || !scheduleData.transactionDateTo || !scheduleData.workSchedule) {
                        allSchedulesValid = false;
                    } else {
                        const schedules = generateSchedules(employeeInfo, scheduleData, overrides);
                        schedules.forEach(schedule => allSchedulePromises.push(saveScheduleToDB(schedule)));
                    }
                });
                if (!allSchedulesValid) {
                    showStatusMessage('Please fill out all fields in every schedule block.', 'error');
                    return;
                }
                showStatusMessage(`Saving ${allSchedulePromises.length} schedule entries...`, 'info');
                try {
                    await Promise.all(allSchedulePromises);
                    showStatusMessage('Schedules saved to database successfully!', 'success');
                    scheduleForm.reset();
                    document.querySelectorAll('.specific-change-block:not(#specific-change-template), .vacation-leave-block:not(#vacation-leave-template)').forEach(b => b.remove());
                } catch (error) {
                    console.error("Error saving schedules:", error);
                    showStatusMessage('An error occurred while saving schedules.', 'error');
                }
            });

            async function saveScheduleToDB(scheduleData) {
                if (!currentUserId) throw new Error("User not authenticated.");
                const docId = `${scheduleData.owfId}_${scheduleData.date}`;
                const docRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/schedules`, docId);
                await setDoc(docRef, scheduleData);
            }
            
            function generateSchedules(employeeInfo, scheduleData, overrides) {
                const generated = [];
                const startDate = new Date(scheduleData.transactionDateFrom);
                const endDate = new Date(scheduleData.transactionDateTo);
                if (isNaN(startDate) || isNaN(endDate)) return [];
                startDate.setMinutes(startDate.getMinutes() + startDate.getTimezoneOffset());
                endDate.setMinutes(endDate.getMinutes() + endDate.getTimezoneOffset());
                const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const currentDateString = d.toLocaleDateString('en-CA');
                    const dayOfWeek = dayNames[d.getDay()].toLowerCase();
                    let scheduleToDisplay = '';
                    const overrideKey = `${employeeInfo.owfId}-${currentDateString}`;
                    if (overrides.hasOwnProperty(overrideKey)) {
                        scheduleToDisplay = convertToMilitaryTime(overrides[overrideKey]);
                    } else if (overrides.hasOwnProperty(dayOfWeek)) {
                        scheduleToDisplay = convertToMilitaryTime(overrides[dayOfWeek]);
                    } else {
                        scheduleToDisplay = (scheduleData.restDay && dayOfWeek === scheduleData.restDay.toLowerCase()) ? 'RESTDAY' : convertToMilitaryTime(scheduleData.workSchedule);
                    }
                    const totalHours = calculateWorkHours(scheduleToDisplay);
                    generated.push({ ...employeeInfo, date: currentDateString, schedule: scheduleToDisplay, totalHours });
                }
                return generated;
            }

            clearButton.addEventListener('click', () => {
                csvDataToSave = [];
                saveCsvDataBtn.classList.add('hidden');
                tableTitle.textContent = "Schedules from Database";
                currentPage = 1;
                applyAndRenderFilters();
                showStatusMessage('Table view cleared.', 'info');
            });

            exportButton.addEventListener('click', () => {
                const table = document.querySelector('table');
                if (table.rows.length <= 1) {
                    showStatusMessage('Nothing to export.', 'error');
                    return;
                }
                let csv = [];
                let headers = [];
                table.querySelectorAll('th').forEach((header, index) => {
                    if (index > 0) headers.push(`"${header.textContent}"`);
                });
                csv.push(headers.join(','));
                
                table.querySelectorAll('tbody tr').forEach(row => {
                    let rowData = [];
                    row.querySelectorAll('td').forEach((cell, index) => {
                        if (index > 0) rowData.push(`"${cell.textContent.replace(/"/g, '""')}"`);
                    });
                    if (rowData.length > 0) {
                       csv.push(rowData.join(','));
                    }
                });
                downloadCSV(csv.join('\n'), 'employee_schedule_export.csv');
            });
            
            addScheduleBtn.addEventListener('click', () => {
                scheduleBlockCount++;
                const newBlock = document.createElement('div');
                newBlock.className = 'schedule-block mt-6 pt-6 border-t border-slate-200';
                newBlock.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-slate-700">Schedule ${scheduleBlockCount}</h3><button type="button" class="remove-schedule-btn text-sm font-medium text-red-600 hover:text-red-800">&times; Remove</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-sm font-medium text-slate-700">Date From</label><input type="date" name="transactionDateFrom" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required></div><div><label class="block text-sm font-medium text-slate-700">Date To</label><input type="date" name="transactionDateTo" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" required></div><div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700">Work Schedule</label><input type="text" name="workSchedule" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., 9am-6pm" required></div><div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700">Rest Day</label><select name="restDay" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"><option value="">Select a Day</option><option value="Sunday">Sunday</option><option value="Monday">Monday</option><option value="Tuesday">Tuesday</option><option value="Wednesday">Wednesday</option><option value="Thursday">Thursday</option><option value="Friday">Friday</option><option value="Saturday">Saturday</option><option value="Unknown">Unknown</option></select></div></div>`;
                scheduleBlocksContainer.appendChild(newBlock);
            });
            scheduleBlocksContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-schedule-btn')) e.target.closest('.schedule-block').remove(); });
            addVacationLeaveBtn.addEventListener('click', () => { const b = vacationLeaveTemplate.cloneNode(true); b.id = ''; b.classList.remove('hidden'); vacationLeaveContainer.appendChild(b); });
            vacationLeaveContainer.addEventListener('click', (e) => { if (e.target.closest('.remove-leave-btn')) e.target.closest('.vacation-leave-block').remove(); });
            addSpecificChangeBtn.addEventListener('click', () => { const b = specificChangeTemplate.cloneNode(true); b.id = ''; b.classList.remove('hidden'); specificChangesContainer.appendChild(b); });
            specificChangesContainer.addEventListener('click', (e) => { if (e.target.closest('.remove-specific-btn')) e.target.closest('.specific-change-block').remove(); });
        
            // Pagination Event Listeners
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    applyAndRenderFilters();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                 const sourceData = csvDataToSave.length > 0 ? csvDataToSave : schedulesFromDB;
                 const filteredSchedules = sourceData.filter(schedule => {
                    const owfIdMatch = String(schedule.owfId).toLowerCase().includes(filterOwfId.value.trim().toLowerCase());
                    const nameMatch = String(schedule.employeeName).toLowerCase().includes(filterName.value.trim().toLowerCase());
                    return owfIdMatch && nameMatch;
                });
                const totalItems = filteredSchedules.length;
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    applyAndRenderFilters();
                }
            });

            itemsPerPageSelect.addEventListener('change', (e) => {
                itemsPerPage = parseInt(e.target.value);
                currentPage = 1;
                applyAndRenderFilters();
            });
            
            // Filter Event Listeners
            [filterOwfId, filterName, filterSchedule, filterDate, filterAgency, filterZone, filterSite].forEach(el => {
                el.addEventListener('input', applyAndRenderFilters);
            });

            clearFilterBtn.addEventListener('click', () => {
                filterOwfId.value = '';
                filterName.value = '';
                filterAgency.value = '';
                filterDate.value = '';
                filterSchedule.value = '';
                filterZone.value = '';
                filterSite.value = '';
                applyAndRenderFilters();
            });
            
            // Delete Logic
            const outputTableBody = document.getElementById('output-table-body');
            outputTableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('delete-checkbox')) {
                    const docId = e.target.dataset.docId;
                    if (e.target.checked) {
                        selectedToDelete.add(docId);
                    } else {
                        selectedToDelete.delete(docId);
                    }
                    deleteSelectedBtn.classList.toggle('hidden', selectedToDelete.size === 0);
                }
            });

            selectAllCheckbox.addEventListener('change', (e) => {
                const checkboxes = outputTableBody.querySelectorAll('.delete-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                    const docId = checkbox.dataset.docId;
                    if (e.target.checked) {
                        selectedToDelete.add(docId);
                    } else {
                        selectedToDelete.delete(docId);
                    }
                });
                deleteSelectedBtn.classList.toggle('hidden', selectedToDelete.size === 0);
            });

            deleteSelectedBtn.addEventListener('click', async () => {
                if (selectedToDelete.size === 0) {
                    showStatusMessage('No items selected to delete.', 'info');
                    return;
                }
                
                const confirmed = await showConfirmationModal(`Are you sure you want to delete ${selectedToDelete.size} records? This cannot be undone.`);
                
                if (!confirmed) {
                    showStatusMessage('Delete operation cancelled.', 'info');
                    return;
                }

                showStatusMessage(`Deleting ${selectedToDelete.size} records...`, 'info');
                const deletePromises = [];
                selectedToDelete.forEach(docId => {
                    deletePromises.push(deleteScheduleFromDB(docId));
                });

                try {
                    await Promise.all(deletePromises);
                    showStatusMessage(`${selectedToDelete.size} records deleted successfully.`, 'success');
                    selectedToDelete.clear();
                    deleteSelectedBtn.classList.add('hidden');
                    selectAllCheckbox.checked = false;
                } catch (error) {
                    console.error("Error deleting records:", error);
                    showStatusMessage('An error occurred while deleting records.', 'error');
                }
            });

            async function deleteScheduleFromDB(docId) {
                if (!currentUserId) throw new Error("User not authenticated.");
                const docRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/schedules`, docId);
                await deleteDoc(docRef);
            }

            // Scrollbar Sync
            topScrollbarContainer.addEventListener('scroll', () => {
                if (isScrolling) return;
                isScrolling = true;
                bottomScrollbarContainer.scrollLeft = topScrollbarContainer.scrollLeft;
                isScrolling = false;
            });

            bottomScrollbarContainer.addEventListener('scroll', () => {
                if (isScrolling) return;
                isScrolling = true;
                topScrollbarContainer.scrollLeft = bottomScrollbarContainer.scrollLeft;
                isScrolling = false;
            });

            // Modal confirmation logic
            modalCancelBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                if (deleteResolver) deleteResolver(false);
            });
            modalConfirmBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                if (deleteResolver) deleteResolver(true);
            });
            
        });

        // --- UTILITY FUNCTIONS ---
        function showStatusMessage(message, type = 'info', persistent = false) {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
            const typeClasses = { success: 'bg-teal-100 text-teal-800', error: 'bg-red-100 text-red-800', info: 'bg-sky-100 text-sky-800' };
            statusMessage.className = `mt-6 text-center p-3 rounded-lg font-medium ${typeClasses[type] || typeClasses['info']}`;
            if (!persistent) {
                setTimeout(() => { statusMessage.style.display = 'none'; }, 7000);
            }
        }

        function showAuthStatus(message, type = 'info') {
            authStatus.textContent = message;
            authStatus.classList.remove('hidden');
            const typeClasses = { success: 'bg-teal-100 text-teal-800', error: 'bg-red-100 text-red-800', info: 'bg-sky-100 text-sky-800' };
            authStatus.className = `text-center mb-4 p-2 rounded-lg text-sm font-medium ${typeClasses[type] || typeClasses['info']}`;
        }
        
        function showConfirmationModal(message) {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                confirmationModal.classList.remove('hidden');
                deleteResolver = resolve;
            });
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.setAttribute("href", URL.createObjectURL(blob));
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        function parseCsvLine(line) {
            const columns = [];
            const regex = /(?:"([^"]*(?:""[^"]*)*)"|([^,]*))(,|$)/g;
            let match;
            while ((match = regex.exec(line))) {
                let column = match[1] !== undefined ? match[1].replace(/""/g, '"') : match[2];
                columns.push(column.trim());
                if (match[3] === '') break;
            }
            return columns;
        }
        function convertToMilitaryTime(timeString) {
            if (!timeString || typeof timeString !== 'string' || timeString.toUpperCase().includes('REST') || timeString.toUpperCase().includes('LEAVE')) return timeString.toUpperCase();
            const parts = timeString.replace(/–|—/g, '-').split('-').map(part => part.trim());
            if (parts.length !== 2) return timeString;
            const convertSingleTime = (part) => {
                let time = part.toLowerCase().replace(/\s/g, '');
                let hours, minutes = 0;
                const ampmMatch = time.match(/^(\d{1,2})(?::(\d{2}))?(am|pm)$/);
                if (ampmMatch) {
                    hours = parseInt(ampmMatch[1], 10);
                    minutes = ampmMatch[2] ? parseInt(ampmMatch[2], 10) : 0;
                    const period = ampmMatch[3];
                    if (period === 'am' && hours === 12) hours = 0;
                    else if (period === 'pm' && hours !== 12) hours += 12;
                } else {
                    const militaryMatch = time.match(/^(\d{2,4})$/);
                    if (militaryMatch) {
                        const t = militaryMatch[1].padStart(4, '0');
                        hours = parseInt(t.substring(0, 2), 10);
                        minutes = parseInt(t.substring(2, 4), 10);
                    } else return part;
                }
                if (isNaN(hours) || isNaN(minutes) || hours > 23 || minutes > 59) return part;
                return hours.toString().padStart(2, '0') + minutes.toString().padStart(2, '0');
            };
            return parts.map(convertSingleTime).join('-');
        }
        function calculateWorkHours(militarySchedule) {
            if (!militarySchedule || !militarySchedule.includes('-')) return 0;
            const parts = militarySchedule.split('-');
            if (parts.length !== 2) return 0;
            const [startTime, endTime] = parts;
            if (startTime.length !== 4 || endTime.length !== 4) return 0;
            const startHour = parseInt(startTime.substring(0, 2), 10);
            const startMinute = parseInt(startTime.substring(2, 4), 10);
            const endHour = parseInt(endTime.substring(0, 2), 10);
            const endMinute = parseInt(endTime.substring(2, 4), 10);
            if ([startHour, startMinute, endHour, endMinute].some(isNaN)) return 0;
            let startTotalMinutes = startHour * 60 + startMinute;
            let endTotalMinutes = endHour * 60 + endMinute;
            if (endTotalMinutes < startTotalMinutes) endTotalMinutes += 24 * 60;
            return (endTotalMinutes - startTotalMinutes) / 60;
        }
    </script>
</body>
</html>
